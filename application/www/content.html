<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">

	<title></title>

	<script src="http://10.0.0.1/lib/spaceifyinitialize.js"></script>						<!-- Use Spaceify's classes. Wait for spaceifyReady event! -->

	<script type="text/javascript">
		//document.domain = window.location.hostname;											// Same Origin Policy, bigscreen has the same domain

		var pictureViewer = null;

		/*****************
		* DOM AND EVENTS *
		*****************/
		window.addEventListener("spaceifyReady", function()
		{
			pictureViewer = new PictureViewer(window.parent.bs_id);							// This iframe is identified by its parents id
			pictureViewer.initialize();

			window.addEventListener("resize", pictureViewer.resize, false);
		}, false);

		/***************
		* PicureViewer *
		***************/
		function PictureViewer(bs_id)
		{
			var self = this;
			var pictures = [];
			var picturesPos = -1;
			var pictureWidth = 0;
			var pictureHeight = 0;
			var pictureTimeoutId = null;
			var messageTimeoutId = null;
			var pv_service_name = "spaceify.org/services/pictureviewer";
			var content_id = Math.floor(Math.random() * (Math.pow(2, 32) - 1));

			var MAX_PICTURES = 4;
			var FADEIN_TIME = 500;
			var FADEOUT_TIME = 500;
			var INFO_TIMEOUT = 5 * 1000;
			var PICTURE_TIMEOUT = 5 * 1000;
			var RECONNECT_TIMEOUT = 10 * 1000;

			var request = new SpaceifyRequest();
			var network = new SpaceifyNetwork();
			var services = new SpaceifyService();

			self.initialize = function()
			{
				request																		// Use chaining to prepare tags for load
				.addjQuery()
				.addCSS("content.css", "pv_content_css", request.head(window), "screen", "spaceify/pictureviewer")
				.addJS("language.js", "pv_content_language", request.head(window), "spaceify/pictureviewer")
				.load(function()
				{
					bindOnLoad();
					connect();
				});
			}

			var bindOnLoad = function()
			{   // Bind onload event handler to the picture element. Fired when src is changed.
				jQuery("#picture").load(function()
				{
					pictureWidth = jQuery(this).width();
					pictureHeight = jQuery(this).height();
					self.resize();

					jQuery(this).fadeIn(FADEIN_TIME, function()
					{
						picturesPos++;
						pictureTimeoutId = setTimeout(loadPicture, PICTURE_TIMEOUT);
					});
				});
			}

			var connect = function()
			{ // Picture viewer spacelet is already started and just connect to it
				services.connectService(pv_service_name, false, function(err, service)
				{
					if(err)
						disconnectionListener("");
					else
					{
						services.setDisconnectionListener(service, disconnectionListener);			// Try to reconnect if connection is lost

						service.exposeMethod("showPicture", self, self.showPicture);				// Messages from client.js

						service.callRPC("contentConnect", [bs_id], null, null);						// Notify spacelet of connected content

						var getobj = network.parseGET(window.location.href);						// Show the initially requested image
						self.showPicture(getobj.pid);
					}
				});
			}

			var disconnectionListener = function(service_name)
			{
				window.setTimeout(connect, RECONNECT_TIMEOUT * 1000);								// Try to reconnect
			}

			self.showPicture = function(pid)
			{
				var ppos = -1;																// Is image already in the array
				for(var p=0; p<pictures.length; p++)
				{
					if(pictures[p] == pid)
					{ ppos = p; break; }
				}

				if(ppos == -1)																// Add only new pictures to the array
				{
					if(pictures.length == MAX_PICTURES)											// Max pictures -> remove first
						pictures.shift();
					pictures.push(pid);
					picturesPos = pictures.length - 1;
				}
				else																		// Show existing image
					picturesPos = ppos;

				loadPicture();

				return 1;																	// Return 1 for spacelet (see spacelets showPicture)
			}

			var loadPicture = function()
			{
				if(pictureTimeoutId)														// Clear previous timer
					window.clearTimeout(pictureTimeoutId);
				pictureTimeoutId = null;

				var vobj = (jQuery("#picture").is(":visible") ? jQuery("#picture") : jQuery("#info"));
				vobj.fadeOut(FADEOUT_TIME, function()
				{
					if(picturesPos == pictures.length)										// Show info page
					{
						picturesPos = 0;
						jQuery("#info").fadeIn(FADEIN_TIME);
						pictureTimeoutId = setTimeout(loadPicture, INFO_TIMEOUT);
					}
					else																	// Show image
					{
						var pict = jQuery("#picture");
						pict.width("auto");														// "Reset" size or otherwise the image won't be resized in the load event
						pict.height("auto");
						pict.attr("src", "http://hs10.snstatic.fi/webkuva/taysi/2000/" + pictures[picturesPos]);
					}
				});
			}

			self.resize = function()
			{
				var pict = jQuery("#picture");
				if(!pict || pict.length == 0)
					return;

				var picturew = pictureWidth;
				var pictureh = pictureHeight;
				var screenw = jQuery(window).width();
				var screenh = jQuery(window).height();

				var wratio = 1.0;															// If the picture is wider and/or taller than the screen, use the smaller ratio to scale it.
				var hratio = 1.0;
				if(picturew > screenw)
					wratio = screenw / picturew;
				if(pictureh > screenh)
					hratio = screenh / pictureh;
				var ratio = Math.min(wratio, hratio);

				picturew = Math.round(picturew * ratio);
				pictureh = Math.round(pictureh * ratio);

				pict.width(picturew);
				pict.height(pictureh);
				pict.css("position", "absolute");
				pict.css("top", (Math.abs(screenh - pictureh) / 2) + "px");
				pict.css("left", (Math.abs(screenw - picturew) / 2) + "px");
			}

		}
	</script>
</head>

<body>
	<img id="picture" src="" alt=""></img>

	<div id="info" class="info">
		<h2>&nbsp;T&auml;ll&auml; n&auml;yt&ouml;ll&auml; n&auml;ytet&auml;&auml;n k&auml;ytt&auml;jien valitsemia kuvia Helsingin Sanomien verkkolehden sivuilta.</h2>

		<br>&nbsp;&nbsp;Alla ohje miten kuvia saa n&auml;yt&ouml;lle:<br>

		<ul type="square">
			<li>Yhdist&auml; mobiililaitteesi spaceify-nimiseen avoimeen langattomaan verkkoon.</li>
			<li>K&auml;ynnist&auml; laitteesi webselain ja mene osoitteeseen <u>hs.fi</u>.</li>
			<li>Sivustoa selatessa kuvien yl√§- ja alareunaan ilmestyy vihre&auml;t reunukset. Klikkaa kuvaa n&auml;ytt&auml;&auml;ksesi sen.</li>
		</ul>

		<br>

		<h2>&nbsp;On this screen are user selected pictures from the Helsingin Sanomat online news service.</h2>

		<br>&nbsp;&nbsp;Below are instructions how to show pictures on the screen:<br>

		<ul type="square">
			<li>Connect your mobile device to the open wireless network called spaceify.</li>
			<li>Start your devices web browser and browse to address <u>hs.fi</u>.</li>
			<li>The pictures on the web page have green bars on top and bottom of the pictures. Clicking these pictures shows them on the screen.</li>
		</ul>
	</div>
</body>
</html>
